<!doctype html>
<html lang="en">
{% include 'base/head.html' %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/doc.css') }}?v=g.random}">
<body>
{% include 'base/navbar.html' %}
<div class="container">
    <div class="header">
        <h4>
            {% if doc.seq != 1 %}
            <a href="/doc/{{doc['seq']-1}}">
                <i class="fas fa-chevron-left"></i>
            </a>
            {% endif %}

            #{{doc.seq}} {{doc['title']}}
            <a href="/doc/{{doc['seq']+1}}">
                <i class="fas fa-chevron-right"></i>
            </a>
            <button type="button"
                    id="view-mode-btn"
                    style="float:right; margin-top: -5px;"
                    class="btn btn-light">
                <i class="fas fa-exchange-alt"></i> <span>sentence mode</span>
            </button>
        </h4>
    </div>

    <form id="doc-upload-form">
        <div class="form-group">
            <!--<label for="doc-uploader">Document Upload</label>-->
            <input type="file" class="form-control-file" id="doc-uploader">
        </div>
    </form>

    <table class="table table-striped">
        <thead>
        <tr>
            <th scope="col">#</th>
            <th scope="col"></th>
        </tr>
        </thead>
        <tbody id="tbody">
        </tbody>
    </table>

    <div class="progress" style="position: fixed; bottom: 0; left: 0; height: 10px; width: 100%; display: none">
        <div class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0"
             aria-valuemax="100">
        </div>
    </div>
</div>
<input type="hidden" id="doc_id" value="{{doc.id}}"/>
<input type="hidden" id="ENCRYPTION_KEY" value="{{ENCRYPTION_KEY}}"/>
{% include 'base/script.html' %}
<script src="{{ url_for('static', filename='js/annotation.js')}}?v={{g.random}}"></script>

<script type='text/template' id='tr-template'>
    <tr class="tr-sentence" id="tr-<%index%>">
        <td class="type-sentence" data-index="<%index%>" scope="row"><%sent%></td>
        <!-- Warning: changing the location of the tag can cause an issue in which the annotation data are not matched. -->
        <td class="type-event" data-index="<%index%>"><%text%></td>
    </tr>
</script>

<script type='text/template' id='attribute-input-group-template'>
    <div class="input-group attribute-input-group row pb-2">
        <div class="input-group-prepend">
            <span class="input-group-text"><%title%>:</span>
        </div>
        <div class="dropdown attribute" id="<%attribute%>">
            <button class="btn btn-sm dropdown-toggle" type="button" id="<%attribute%>-val"
                    data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            </button>
            <div class="dropdown-menu" aria-labelledby="<%attribute%>-val">
            </div>
        </div>
        <div class="input-group">
            <input type="text" class="form-control memo-reason" placeholder="memo" id="<%attribute%>-memo" value="">
            <input type="text" class="form-control memo-reason" placeholder="reason" id="<%attribute%>-reason" value="">
        </div>
    </div>
</script>

<script type='text/template' id='attribute-button-template'>
    <button class="dropdown-item" type="button" data-value="<%value%>">
        <%value_space%>
    </button>
</script>

<div class="modal fade" id="modal" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"></h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form>
                    <div class="row" id="">
                        <div class="col-md-6" id="col1">
                        </div>
                        <div class="col-md-6" id="col2">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger btn-sm" id="modal-delete-btn">Delete</button>
                <button type="button" class="btn btn-outline-primary btn-sm" id="modal-save-btn">Save</button>
            </div>
        </div>
    </div>
</div>

<script>
  const event = {
    state: {
      view_mode: 'paragraph',
      target_sent: {
        index: 0,
        min: 0,
        max: 0,
      },
    },
    selection_listen: function () {
      document.onmouseup = document.onkeyup = function () {
        const selection = window.getSelection();
        if (selection.type !== 'Range') return;

        const anchorNodeParent = selection.anchorNode.parentElement;
        const focusNodeParent = selection.focusNode.parentElement;

        if (anchorNodeParent.className !== 'type-event' && anchorNodeParent.className !== 'type-sentence') return;
        if (anchorNodeParent.className !== focusNodeParent.className) return;
        if (anchorNodeParent.getAttribute('data-index') !== focusNodeParent.getAttribute('data-index')) return;

        const index = Number(anchorNodeParent.getAttribute('data-index'));
        const entire_text = anchorNodeParent.innerText;
        const common_offset = entire_text.indexOf(selection.anchorNode.data);
        let anchor_offset = selection.anchorOffset + common_offset;
        let focus_offset = selection.focusOffset + common_offset;

        const selection_text = selection.toString();

        for (let i = 0; i < selection_text.length; i++) {
          // To detect &nbsp;(&nbsp;'s chartCode is 160 and space chartCode is 32).
          if (selection_text.charCodeAt(i) === 160 || selection_text[i] === ' ') anchor_offset++;
          else break;
        }
        for (let i = selection_text.length - 1; i >= 0; i--) {
          if (selection_text.charCodeAt(i) === 160 || selection_text[i] === ' ') focus_offset--;
          else break;
        }
        if (anchor_offset >= focus_offset) return;
        if (anchor_offset < 0 || anchor_offset > entire_text.length) return;
        if (focus_offset < 0 || focus_offset > entire_text.length) return;

        let type = 'event';
        if (anchorNodeParent.className === 'type-sentence') type = 'sentence';
        const item = {
          target_text: entire_text.substr(anchor_offset, focus_offset - anchor_offset),
          index: index,
          anchor_offset: anchor_offset,
          focus_offset: focus_offset,
          type: type,
          basket: {},
        };

        const range = selection.getRangeAt(0);
        const bound = range.getBoundingClientRect();
        const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
        modal.set_position(bound.left, bound.top + scrollTop);

        let attributes = annotation.attributes[type];
        for (let key in attributes) {
          let options = attributes[key].options;
          let attribute_key = attributes[key].attribute_key;
          let initial_value = options[annotation.random(options.length)];
          initial_value = initial_value.split(' ').join('_');
          item.basket[attribute_key] = {
            initial_value: initial_value,
            value: '',
            memo: '',
            reason: '',
          }
        }

        api.post_annotation(item, function (data) {
          const annotation_item = data['annotation'];
          annotation.add(annotation_item);
          renderer.render_table();

          modal.set_annotation_item(annotation_item);

          if (annotation_item.type === 'sentence') {
            modal.show();
            modal.state.step = 0;
            modal.next_step();
          }
        });

      }.bind(this);
    },
    listen_view_mode: function () {
      $('#view-mode-btn').click(function () {
        if (event.state.view_mode === 'paragraph') {
          event.state.view_mode = 'sentence';
          $('#view-mode-btn span').html('paragraph mode');
          $('table').removeClass('table-striped');
          $('.progress').show();
        } else {
          event.state.view_mode = 'paragraph';
          $('#view-mode-btn span').html('sentence mode');
          $('table').addClass('table-striped');
          $('.progress').hide();
        }
        renderer.render_table();
      });
    },
    listen_annotation_badge: function () {
      $('.annotation-badge').click(function (e) {
        const annotation_id = $(this).attr('data-id');
        const annotation_item = annotation.find_by_id(annotation_id);

        modal.set_position(e.pageX, e.pageY);
        modal.set_annotation_item(annotation_item);
        modal.show();
        modal.state.step = 0;
        modal.next_step();
      });
    },
    listen_tooltip: function () {
      $('[data-toggle="tooltip"]').tooltip();
      // $('[data-toggle="tooltip"]').tooltip('show');
    },
    listen_key: function () {
      $(document).keydown(function (e) {
        switch (e.which) {
          case 13: // enter
            break;
          case 37: // left
            if (event.state.target_sent.index > event.state.target_sent.min) {
              event.state.target_sent.index--;
            }
            renderer.render_table();
            e.preventDefault();
            break;
          case 39: // right
            if (event.state.target_sent.index < event.state.target_sent.max) {
              event.state.target_sent.index++;
            }
            renderer.render_table();
            e.preventDefault();
            break;
          case 38: // up
            break;
          case 40: // down
            break;
          case 49: // 1
            break;
          case 50: // 2
            break;
          case 51: // 3
            break;
          case 52: // 4
            break;
          case 53: // 5
            break;
          default:
            return;
        }
      });
    }
  };

  const modal = {
    el: null,
    state: {
      step: 1,
      annotation_item: {},
      max_attribute: 11,
    },
    init: function () {
      this.el = $('#modal');
      this.el.modal({
        show: false,
      });
      this.el.draggable({
        handle: '.modal-header',
      });

      $('#modal-delete-btn').click(function () {
        const annotation_id = modal.state.annotation_item.id;
        api.delete_annotation(modal.state.annotation_item.id, function () {
          annotation.remove(annotation_id);
          renderer.render_table();
          modal.el.modal('hide');
        });
      });

      $('#modal-save-btn').click(function () {
        modal.save();
        modal.el.modal('hide');
      });
    },
    next_step() {
      const step = this.state.step + 1;
      if (step === this.state.max_attribute + 1) {
        modal.save();
        modal.el.modal('hide');
        return;
      }

      setTimeout(function () {
        $('#attribute' + step + '-val').click();
        setTimeout(function () {
          $('#attribute' + step + ' .active').focus();
        }, 100);
      }, 200);

      $('.input-group-text').removeClass('text-primary');
      $('#attribute' + step).parents('.input-group').find('.input-group-text').addClass('text-primary');
      $('.dropdown-toggle').removeClass('text-primary');
      $('#attribute' + step + '-val').addClass('text-primary');
    },
    set_annotation_item: function (annotation_item) {
      this.state.annotation_item = annotation_item;
    },
    load_attributes: function () {
      const annotation_type = this.state.annotation_item.type;
      const basket = this.state.annotation_item.basket;
      for (let i = 1; i <= this.state.max_attribute; i++) {
        const attribute_id = 'attribute' + i;

        const attribute_key = annotation.attributes[annotation_type][attribute_id].attribute_key;
        let value = basket[attribute_key].value;
        if (!value) value = basket[attribute_key].initial_value;

        $('#' + attribute_id + '-memo').val(basket[attribute_key].memo);
        $('#' + attribute_id + '-reason').val(basket[attribute_key].reason);

        $('#' + attribute_id + '-val').html(value.split('_').join(' '));

        $('#' + attribute_id + ' .dropdown-item').removeClass('active');
        $('#' + attribute_id + ' .dropdown-item[data-value="' + value + '"]').addClass('active');
      }
    },
    show: function () {
      this.set_header();
      this.el.modal('show');

      const annotation_type = this.state.annotation_item.type;
      this.change_type(annotation_type);
      this.render_input(annotation_type);
      this.load_attributes();
    },
    render_input: function (type) {
      $('#col1').html('');
      $('#col2').html('');

      let attributes = annotation.attributes[type];
      for (let key in attributes) {
        let title = attributes[key].title;
        let options = attributes[key].options;
        let order = attributes[key].order;

        let input_group_template = $('#attribute-input-group-template').html();

        input_group_template = input_group_template.split('<%attribute%>').join(key);
        input_group_template = input_group_template.split('<%title%>').join(title);

        if (order <= 6) {
          $('#col1').append(input_group_template);
        } else {
          $('#col2').append(input_group_template);
        }

        for (let i = 0; i < options.length; i++) {
          let option = options[i];
          let button_template = $('#attribute-button-template').html();
          button_template = button_template.replace('<%value%>', option.split(' ').join('_'));
          button_template = button_template.replace('<%value_space%>', option);

          $('#' + key + ' .dropdown-menu').append(button_template);
        }
      }
      this.input_listen();
    },
    set_header: function () {
      const type = this.state.annotation_item.type;
      let title = 'Event: ' + this.state.annotation_item.target_text;
      if (type === 'sentence') {
        title = 'Sentence' + this.state.annotation_item.index;
      }

      this.el.find('.modal-title').html(title);
    },
    set_position: function (left, top) {
      const window_width = document.body.clientWidth;

      const margin = 20;
      let calibrated_left = Math.max(margin, left - 450);
      calibrated_left = Math.min(calibrated_left, window_width - 850 - margin);
      this.el.css('left', calibrated_left);
      this.el.css('top', top + 50);
    },
    save: function () {
      const annotation_type = this.state.annotation_item.type;
      for (let i = 1; i <= this.state.max_attribute; i++) {
        const attribute_id = 'attribute' + i;
        const value = $('#' + attribute_id + '-val').html().trim().split(' ').join('_');
        const attribute_key = annotation.attributes[annotation_type][attribute_id].attribute_key;
        this.state.annotation_item.basket[attribute_key].value = value;

        const memo = $('#' + attribute_id + '-memo').val();
        const reason = $('#' + attribute_id + '-reason').val();

        this.state.annotation_item.basket[attribute_key].memo = memo;
        this.state.annotation_item.basket[attribute_key].reason = reason;
      }

      api.put_annotation(this.state.annotation_item, function () {
        annotation.update(modal.state.annotation_item.id, modal.state.annotation_item);
        renderer.render_table();
      });
    },
    change_type: function (type) {
      let width = '850px';
      if (type === 'event') {
        $('#col1').removeClass('col-md-12').addClass('col-md-6');
        $('#col2').show();
        this.state.max_attribute = 11;
        for (let i = 6; i <= 11; i++) {
          $('#attribute' + i).parents('.input-group').show();
        }
      } else {
        $('#col1').removeClass('col-md-6').addClass('col-md-12');
        $('#col2').hide();
        this.state.max_attribute = 5;
        for (let i = 6; i <= 11; i++) {
          $('#attribute' + i).parents('.input-group').hide();
        }
        width = '950px';
      }
      $('#modal').css('width', width).css('max-width', width);
      $('#modal .modal-content').css('width', width).css('min-width', width);
    },
    input_listen: function () {
      $('.dropdown-item').click(function () {
        const dropdown = $(this).parents('.dropdown');
        const attribute_id = dropdown.attr('id');
        const dropdown_toggle = dropdown.find('.dropdown-toggle');
        const value = $(this).attr('data-value');

        dropdown.find('.dropdown-toggle').html(value.split('_').join(' '));

        $('#' + attribute_id + ' .dropdown-item').removeClass('active');
        $('#' + attribute_id + ' .dropdown-item[data-value="' + value + '"]').addClass('active');

        modal.state.step = Number(dropdown_toggle.attr('id').replace('attribute', '').replace('-val', ''));
        modal.next_step();
      });

      this.el.keydown(function (e) {
        if (e.keyCode === 13) {
          modal.next_step();
        }
      });
    },
  };

  const renderer = {
    state: {
      sents: [],
    },
    load_annotation_and_render_table: function () {
      api.get_annotation(function (data) {
        annotation.data = data['annotations'];
        renderer.render_table();
      });
    },
    render_table: function () {
      const sents = this.state.sents;

      const tbody = $('#tbody');
      tbody.html('');

      // make annotation map
      const annotation_map = {};
      for (let i = 0; i < sents.length; i++) {
        annotation_map[sents[i].index] = [];
      }
      for (let i = 0; i < annotation.data.length; i++) {
        const item = annotation.data[i];
        annotation_map[item.index].push(item);
      }

      for (let i = 0; i < sents.length; i++) {
        const sent = sents[i];
        let tr = $('#tr-template').html();

        const index = sent['index'];
        const text = sent['text'];

        const annotations = annotation_map[Number(index)];

        tr = tr.split('<%index%>').join(sent['index']);
        tr = tr.replace('<%text%>', this.render_markup_sentence(Number(index), text, annotations));

        let sent_col = 'Sent' + index;
        let sent_markup = '';
        let sentence_type_index = -1;
        for (let j = 0; j < annotations.length; j++) {
          if (annotations[j].type === 'sentence') {
            sentence_type_index = j;
            break;
          }
        }
        if (sentence_type_index !== -1) {
          const annotation_item = annotations[sentence_type_index];
          let badge_type = 'primary';
          if (annotation.is_empty_basket(annotation_item.basket)) {
            badge_type = 'secondary';
          }
          sent_markup += '<span class="badge badge-' + badge_type + ' annotation-badge" data-id="' + annotation_item.id + '" ';
          sent_markup += 'data-toggle="tooltip" data-placement="right" data-html="true" title="' + this.render_tooltip_markup(annotation_item) + '">';
          sent_markup += sent_col + '</span>';
          tr = tr.replace('<%sent%>', sent_markup);
        } else {
          tr = tr.replace('<%sent%>', sent_col);
        }

        tbody.append(tr);
      }

      if (event.state.view_mode === 'sentence') {
        $('.tr-sentence').hide();
        $('#tr-' + event.state.target_sent.index).show();

        const target_sent = event.state.target_sent;
        let ratio = (target_sent.index - target_sent.min + 1) / (target_sent.max - target_sent.min + 1) * 100;
        $('.progress-bar').css('width', ratio + '%');
      }
      event.listen_annotation_badge();
      event.listen_tooltip();
    },
    render_markup_sentence: function (index, text, annotations) {
      const start = {}, end = {};
      for (let i = 0; i < annotations.length; i++) {
        const item = annotations[i];
        if (item.type !== 'event') continue;
        if (item.index !== index) continue;
        start[item.anchor_offset] = i;
        end[item.focus_offset] = i;
      }
      let markup = '';

      for (let i = 0; i < text.length; i++) {
        if (i in start) {
          const annotation_item = annotations[start[i]];
          let badge_type = 'success';
          if (annotation.is_empty_basket(annotation_item.basket)) {
            badge_type = 'secondary';
          }

          markup += '<span class="badge badge-' + badge_type + ' annotation-badge" data-id="' + annotation_item.id + '" ';
          markup += 'data-toggle="tooltip" data-placement="right" data-html="true" title="' + this.render_tooltip_markup(annotation_item) + '">';
        }

        if (text[i] !== ' ') {
          markup += text[i];
        } else {
          markup += '&nbsp;';
        }

        if (i + 1 in end) {
          markup += '</span>';
        }
      }
      // console.log('markup :', markup, start, end);
      return markup;
    },
    render_tooltip_markup: function (annotation_item) {
      let markup = '';
      const annotation_type = annotation_item['type'];
      for (let key in annotation.attributes[annotation_type]) {
        const attribute_key = annotation.attributes[annotation_type][key].attribute_key;
        const order = annotation.attributes[annotation_type][key].order;
        if (attribute_key in annotation_item.basket && annotation_item.basket[attribute_key].value) {
          markup += order + '. ' + attribute_key + ': <em>' + annotation_item.basket[attribute_key].value + '</em><br/>'
        }
      }
      return markup;
    },
  };

  const text_reader = {
    data_text: '',
    data_json: {},
    listen: function () {
      let input = document.getElementById("doc-uploader");
      input.addEventListener("change", function () {
        if (this.files && this.files[0]) {
          let myFile = this.files[0];
          let reader = new FileReader();
          reader.addEventListener('load', function (e) {
            text_reader.data_text = e.target.result;
            text_reader.data_text = text_reader.decode_string(text_reader.data_text, $('#ENCRYPTION_KEY').val());
            text_reader.data_json = JSON.parse(text_reader.data_text);
            let doc_id = $('#doc_id').val();

            if (doc_id === text_reader.data_json['doc_id']) {
              localStorage.setItem(text_reader.data_json['doc_id'], text_reader.data_text);
              location.reload();
            } else {
              swal({
                title: '',
                text: 'The document number does not match.',
                type: 'error',
              });
            }
            console.log(text_reader.data_json);
          });
          reader.readAsBinaryString(myFile);
        }
      });
    },
    decode_string: function (input, key) {
      input = input.split(',');
      let c = '';
      while (key.length < input.length) {
        key += key;
      }
      for (let i = 0; i < input.length; i++) {
        let value1 = input[i];
        let value2 = key[i].charCodeAt(0);

        let xor = value1 ^ value2;
        c += String.fromCharCode(xor);
      }
      return c;
    }
  };

  $(document).ready(function () {
    event.selection_listen();
    event.listen_view_mode();
    event.listen_key();

    text_reader.listen();

    api.get_doc_by_local(function (data) {
      if (data) {
        $('#doc-upload-form').hide();
        const sents = data['sents'];
        renderer.state.sents = sents;

        event.state.target_sent.min = sents[0]['index'];
        event.state.target_sent.index = sents[0]['index'];
        event.state.target_sent.max = sents[sents.length - 1]['index'];

        renderer.load_annotation_and_render_table();
      }
    });
    modal.init();
  })

</script>
</body>
</html>