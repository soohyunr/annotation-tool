<!doctype html>
<html lang="en">
{% include 'base/reacthead.html' %}
<style>
    .pagination {
        margin: 40px 20px 70px 0;
        float: right;
    }

    table tr {
        text-align: center;
    }

    table td {
        text-align: center;
    }

    .page-link {
        color: #6c757d;
    }
</style>
    

<body>
{% include 'base/sentence_navbar.html' %}
<div class="container">
    
    
    <table class="table">
        <thead>
        <tr>
            <th scope="col">#</th>
            <th>text</th>
            <th>writer</th>
            <th>reactions</th>
            <th><img src="/static/img/like.svg" style="width:20px;height:20px;"></th>
        </tr>
        </thead>
        <tbody>
        {% for psent in prevsents %}
        <tr>
            <td>
                <a href="/view_sent/{{psent.id}}">
                    {{psent['depth']}}
                </a>
            </td>
            <td>
                <a href="/view_sent/{{psent.id}}">
                    {{psent['text']}}
                </a>
            </td>
            <td>
                <a href="/view_user/{{psent.user.username}}">
                    {{psent['user'].username}}
                </a>
            </td>
            <td>
                <a class="reaction-show" data-reactions="{{psent['reacts']['likes']}}">
                {%if (psent['reacts']['total_reacts']) == 0%}0 <img src="{{"/static/img/like.svg"}}" style="width:20px;height:20px;">
                {% else %}
                    {{psent['reacts']['total_reacts']}} <img src="{{"/static/img/" + psent['reacts']['most'] + ".svg"}}" style="width:20px;height:20px;">
                {% endif %}
                </a>
            </td>
            <td>
                
                    <a class="FB_reactions" data-reactions-type='horizontal' data-unique-id="1" data-emoji-class="{{psent['reacts']['likes'][g.user['username']]}}" data-sent-id="{{psent.id}}">
                        <span>{%if (psent['reacts']['likes'][g.user['username']]) == null%}
                            LIKE {% else %} {{psent['reacts']['likes'][g.user['username']]}} {% endif %}
                            </span>
                    </a>
                 
            
            </td>
        </tr>
        {% endfor %}
        <tr>
            <td>
                <a href="/view_sent/{{sent.id}}">
                    {{sent['depth']}}
                </a>
            </td>
            <td>
                <a href="/view_sent/{{sent.id}}">
                    {{sent['text']}}
                </a>
            </td>
            <td>
                <a href="/view_user/{{sent.user.username}}">
                    {{sent['user'].username}}
                </a>
            </td>
            <td>
                <a class="reaction-show" data-reactions="{{sent['reacts']['likes']}}">
                {%if (sent['reacts']['total_reacts']) == 0%}0 <img src="{{"/static/img/like.svg"}}" style="width:20px;height:20px;">
                {% else %}
                    {{sent['reacts']['total_reacts']}} <img src="{{"/static/img/" + sent['reacts']['most'] + ".svg"}}" style="width:20px;height:20px;">
                {% endif %}
                </a>
            </td>
            <td>
              
                    <a class="FB_reactions" data-reactions-type='horizontal' data-unique-id="1" data-emoji-class="{{sent['reacts']['likes'][g.user['username']]}}" data-sent-id="{{sent.id}}">
                        <span>{%if (sent['reacts']['likes'][g.user['username']]) == null%}
                            LIKE {% else %} {{sent['reacts']['likes'][g.user['username']]}} {% endif %}</span>
                    </a>
 
            
            </td>
        </tr>
        </tbody>
    </table>
    
    
        
    <form>    
      <div class="form-group">
        <label for="exampleFormControlTextarea1">Write a sentence that continues the story above</label>
        <textarea class="form-control" id="storyForm" rows="2" data-sent-type="{{sent['sent_type']}}"></textarea>
      </div>    
    <button type="button" class="btn btn-primary" id="submit-btn">Submit</button>
    </form>
    
    <table class="table">
        <thead>
        <tr>
            <th scope="col">#</th>
            <th>text</th>
            <th>writer</th>
            <th>reactions</th>
            <th><img src="/static/img/like.svg" style="width:20px;height:20px;"></th>
        </tr>
        </thead>
        <tbody>
        {% for child in children %}
        <tr>
            <td>
                <a href="/view_sent/{{child.id}}">
                    {{child['depth']}}
                </a>
            </td>
            <td>
                <a href="/view_sent/{{child.id}}">
                    {{child['text']}}
                </a>
            </td>
            <td>
                <a href="/view_user/{{child.user.username}}">
                    {{child['user'].username}}
                </a>
            </td>
            <td>
                <a class="reaction-show" data-reactions="{{child['reacts']['likes']}}">
                {%if (child['reacts']['total_reacts']) == 0%}0 <img src="{{"/static/img/like.svg"}}" style="width:20px;height:20px;">
                {% else %}
                    {{child['reacts']['total_reacts']}} <img src="{{"/static/img/" + child['reacts']['most'] + ".svg"}}" style="width:20px;height:20px;">
                {% endif %}
                </a>
            </td>
            <td>
                <a class="FB_reactions" data-reactions-type='horizontal' data-unique-id="1" data-emoji-class="{{child['reacts']['likes'][g.user['username']]}}" data-sent-id="{{child.id}}">
                        <span>{%if (child['reacts']['likes'][g.user['username']]) == null%}
                            LIKE {% else %} {{child['reacts']['likes'][g.user['username']]}} {% endif %}</span>
                    </a>
            
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% include 'base/script.html' %}

<script>
  $('#submit-btn').click(function () {
    var text = $('#storyForm').val().trim();
    var sent_type = $('#storyForm').data('sent-type')
    var parent_id = window.location.href["split"]("_sent/")[1]["split"]("?")[0]
    
    if (!text) {
      swal({
        title: '',
        text: 'Please enter the text.',
        type: 'error',
      });
      return;
    }

    $(this).hide();
    $.ajax({
      url: '/api/sentence/upload',
      contentType: 'application/json',
      type: 'POST',
      data: JSON.stringify({
        text: text,
        is_root: false,
        parent_id: parent_id,
        sent_type : sent_type,
      }),
    }).done(function (data) {
      var doc = JSON.parse(data);
      location.assign('/view_sent/' + doc.id);
    }).fail(function () {
      $(this).show();
      swal({
        title: '',
        text: 'Error occurred. Please contact the administrator.',
        type: 'error',
      });
    })
  })
  $('.reaction-show').click(function () {

    var reacts = $(this).data('reactions');
    if (jQuery.isEmptyObject(reacts)){
        swal({
        title: 'Reactions',
        text: "no reactions yet!",
      });return 0;
    }
    reacts = JSON.parse(reacts.replace(/'/g,"\""));
    var swal_html='<table class="table"><tbody>'
    for (var username in reacts){
        swal_html += '<tr><td><a href="/view_user/' + username + '">'+ username+ '</a></td><td><a><img src="/static/img/' + reacts[username]+ '.svg" style="width:20px;height:20px;"></a></td><td></tr>'
    }
    swal_html += '</tbody></table>';
    swal({
        title: 'Reactions',
        text: swal_html,
        html: true,
        
      });
    return 0;
    
  })
    
</script>
</body>
</html>
